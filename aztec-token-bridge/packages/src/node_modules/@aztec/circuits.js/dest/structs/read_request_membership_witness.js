import { toBufferBE } from '@aztec/foundation/bigint-buffer';
import { Fr } from '@aztec/foundation/fields';
import { BufferReader } from '@aztec/foundation/serialize';
import { MAX_NEW_COMMITMENTS_PER_CALL, NOTE_HASH_TREE_HEIGHT } from '../constants.gen.js';
import { makeTuple, range } from '../utils/jsUtils.js';
import { serializeToBuffer } from '../utils/serialize.js';
/**
 * A ReadRequestMembershipWitness is similar to a MembershipWitness but includes
 * some additional fields used to direct the kernel regarding whether a read is transient
 * and if so which commitment it corresponds to.
 */
export class ReadRequestMembershipWitness {
    constructor(
    /**
     * Index of a leaf in the Merkle tree.
     */
    leafIndex, 
    /**
     * Sibling path of the leaf in the Merkle tree.
     */
    siblingPath, 
    /**
     * Whether or not the read request corresponds to a pending commitment.
     */
    isTransient = false, 
    /**
     * When transient, the commitment being read was created by some app circuit in the current TX.
     * The kernel will need some hint to efficiently find that commitment for a given read request.
     * When not transient, this can be 0.
     */
    hintToCommitment) {
        this.leafIndex = leafIndex;
        this.siblingPath = siblingPath;
        this.isTransient = isTransient;
        this.hintToCommitment = hintToCommitment;
        if (hintToCommitment.toBigInt() > MAX_NEW_COMMITMENTS_PER_CALL) {
            throw new Error(`Expected ReadRequestMembershipWitness' hintToCommitment(${hintToCommitment}) to be <= NEW_COMMITMENTS_LENGTH(${MAX_NEW_COMMITMENTS_PER_CALL})`);
        }
    }
    toBuffer() {
        return serializeToBuffer(toBufferBE(this.leafIndex.toBigInt(), 32), ...this.siblingPath, this.isTransient, this.hintToCommitment);
    }
    static mock(size, start) {
        return new ReadRequestMembershipWitness(new Fr(start), range(size, start).map(x => new Fr(BigInt(x))), false, new Fr(0));
    }
    /**
     * Creates a random membership witness. Used for testing purposes.
     * @returns Random membership witness.
     */
    static random() {
        return new ReadRequestMembershipWitness(new Fr(0n), makeTuple(NOTE_HASH_TREE_HEIGHT, () => Fr.random()), false, new Fr(0));
    }
    /**
     * Creates a read request membership witness whose sibling path is full of zero fields.
     * @param leafIndex - Index of the leaf in the Merkle tree.
     * @returns Membership witness with zero sibling path.
     */
    static empty(leafIndex) {
        const arr = makeTuple(NOTE_HASH_TREE_HEIGHT, () => Fr.ZERO);
        return new ReadRequestMembershipWitness(new Fr(leafIndex), arr, false, new Fr(0));
    }
    /**
     * Creates a transient read request membership witness.
     * @returns an empty transient read request membership witness.
     */
    static emptyTransient() {
        const arr = makeTuple(NOTE_HASH_TREE_HEIGHT, () => Fr.ZERO);
        return new ReadRequestMembershipWitness(new Fr(0), arr, true, new Fr(0));
    }
    static fromBufferArray(leafIndex, siblingPath, isTransient, hintToCommitment) {
        return new ReadRequestMembershipWitness(leafIndex, siblingPath.map(x => Fr.fromBuffer(x)), isTransient, hintToCommitment);
    }
    static fromMembershipWitness(membershipWitness, isTransient, hintToCommitment) {
        return new ReadRequestMembershipWitness(new Fr(membershipWitness.leafIndex), membershipWitness.siblingPath, isTransient, hintToCommitment);
    }
    /**
     * Deserializes from a buffer or reader, corresponding to a write in cpp.
     * @param buffer - Buffer or reader to read from.
     * @returns The deserialized `ReadRequestMembershipWitness`.
     */
    static fromBuffer(buffer) {
        const reader = BufferReader.asReader(buffer);
        const leafIndex = Fr.fromBuffer(reader);
        const siblingPath = reader.readArray(NOTE_HASH_TREE_HEIGHT, Fr);
        const isTransient = reader.readBoolean();
        const hintToCommitment = Fr.fromBuffer(reader);
        return new ReadRequestMembershipWitness(leafIndex, siblingPath, isTransient, hintToCommitment);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhZF9yZXF1ZXN0X21lbWJlcnNoaXBfd2l0bmVzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdHJ1Y3RzL3JlYWRfcmVxdWVzdF9tZW1iZXJzaGlwX3dpdG5lc3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQzdELE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUM5QyxPQUFPLEVBQUUsWUFBWSxFQUFTLE1BQU0sNkJBQTZCLENBQUM7QUFFbEUsT0FBTyxFQUFFLDRCQUE0QixFQUFFLHFCQUFxQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDMUYsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUcxRDs7OztHQUlHO0FBQ0gsTUFBTSxPQUFPLDRCQUE0QjtJQUN2QztJQUNFOztPQUVHO0lBQ0ksU0FBYTtJQUNwQjs7T0FFRztJQUNJLFdBQW9EO0lBQzNEOztPQUVHO0lBQ0ksY0FBYyxLQUFLO0lBQzFCOzs7O09BSUc7SUFDSSxnQkFBb0I7UUFkcEIsY0FBUyxHQUFULFNBQVMsQ0FBSTtRQUliLGdCQUFXLEdBQVgsV0FBVyxDQUF5QztRQUlwRCxnQkFBVyxHQUFYLFdBQVcsQ0FBUTtRQU1uQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQUk7UUFFM0IsSUFBSSxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsR0FBRyw0QkFBNEIsRUFBRTtZQUM5RCxNQUFNLElBQUksS0FBSyxDQUNiLDJEQUEyRCxnQkFBZ0IscUNBQXFDLDRCQUE0QixHQUFHLENBQ2hKLENBQUM7U0FDSDtJQUNILENBQUM7SUFFRCxRQUFRO1FBQ04sT0FBTyxpQkFBaUIsQ0FDdEIsVUFBVSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxF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