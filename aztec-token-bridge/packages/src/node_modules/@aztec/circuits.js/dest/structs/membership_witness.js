import { toBigIntBE, toBufferBE } from '@aztec/foundation/bigint-buffer';
import { Fr } from '@aztec/foundation/fields';
import { BufferReader } from '@aztec/foundation/serialize';
import { assertMemberLength, range } from '../utils/jsUtils.js';
import { serializeToBuffer } from '../utils/serialize.js';
/**
 * Contains information which can be used to prove that a leaf is a member of a Merkle tree.
 */
export class MembershipWitness {
    constructor(
    /**
     * Size of the sibling path (number of fields it contains).
     */
    pathSize, 
    /**
     * Index of a leaf in the Merkle tree.
     */
    leafIndex, 
    /**
     * Sibling path of the leaf in the Merkle tree.
     */
    siblingPath) {
        this.leafIndex = leafIndex;
        this.siblingPath = siblingPath;
        assertMemberLength(this, 'siblingPath', pathSize);
    }
    toBuffer() {
        return serializeToBuffer(toBufferBE(this.leafIndex, 32), ...this.siblingPath);
    }
    static mock(size, start) {
        return new MembershipWitness(size, BigInt(start), range(size, start).map(x => new Fr(BigInt(x))));
    }
    /**
     * Creates a random membership witness. Used for testing purposes.
     * @param pathSize - Number of fields in the sibling path.
     * @returns Random membership witness.
     */
    static random(pathSize) {
        return new MembershipWitness(pathSize, 0n, Array(pathSize)
            .fill(0)
            .map(() => Fr.random()));
    }
    /**
     * Creates a membership witness whose sibling path is full of zero fields.
     * @param pathSize - Number of fields in the sibling path.
     * @param leafIndex - Index of the leaf in the Merkle tree.
     * @returns Membership witness with zero sibling path.
     */
    static empty(pathSize, leafIndex) {
        const arr = Array(pathSize)
            .fill(0)
            .map(() => Fr.ZERO);
        return new MembershipWitness(pathSize, leafIndex, arr);
    }
    static fromBufferArray(leafIndex, siblingPath) {
        return new MembershipWitness(siblingPath.length, leafIndex, siblingPath.map(x => Fr.fromBuffer(x)));
    }
    /**
     * Deserializes from a buffer or reader, corresponding to a write in cpp.
     * @param buffer - Buffer or reader to read from.
     * @returns The deserialized `MembershipWitness`.
     */
    static fromBuffer(buffer) {
        const reader = BufferReader.asReader(buffer);
        const leafIndex = toBigIntBE(reader.readBytes(32));
        const siblingPath = reader.readBufferArray();
        return this.fromBufferArray(leafIndex, siblingPath);
    }
    /**
     * Creates a deserializer object for a MembershipWitness with a given size.
     * @param size - Expected size of the witness.
     * @returns A deserializer object.
     */
    static deserializer(size) {
        return {
            fromBuffer: (buffer) => {
                const reader = BufferReader.asReader(buffer);
                const leafIndex = toBigIntBE(reader.readBytes(32));
                const siblingPath = reader.readArray(size, Fr);
                return new MembershipWitness(size, leafIndex, siblingPath);
            },
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVtYmVyc2hpcF93aXRuZXNzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3N0cnVjdHMvbWVtYmVyc2hpcF93aXRuZXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDekUsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxZQUFZLEVBQVMsTUFBTSw2QkFBNkIsQ0FBQztBQUdsRSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsS0FBSyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDaEUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFMUQ7O0dBRUc7QUFDSCxNQUFNLE9BQU8saUJBQWlCO0lBQzVCO0lBQ0U7O09BRUc7SUFDSCxRQUFXO0lBQ1g7O09BRUc7SUFDSSxTQUFpQjtJQUN4Qjs7T0FFRztJQUNJLFdBQXlCO1FBSnpCLGNBQVMsR0FBVCxTQUFTLENBQVE7UUFJakIsZ0JBQVcsR0FBWCxXQUFXLENBQWM7UUFFaEMsa0JBQWtCLENBQUMsSUFBSSxFQUFFLGFBQWEsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBRUQsUUFBUTtRQUNOLE9BQU8saUJBQWlCLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDaEYsQ0FBQztJQUVELE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBWSxFQUFFLEtBQWE7UUFDckMsT0FBTyxJQUFJLGlCQUFpQixDQUMxQixJQUFJLEVBQ0osTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUNiLEtBQUssQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQTRDLENBQzFGLENBQUM7SUFDSixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNJLE1BQU0sQ0FBQyxNQUFNLENBQW1CLFFBQVc7UUFDaEQsT0FBTyxJQUFJLGlCQUFpQixDQUMxQixRQUFRLEVBQ1IsRUFBRSxFQUNGLEtBQUssQ0FBQyxRQUFRLENBQUM7YUFDWixJQUFJLENBQUMsQ0FBQyxDQUFDO2FBQ1AsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBaUIsQ0FDMUMsQ0FBQztJQUNKLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNJLE1BQU0sQ0FBQyxLQUFLLENBQW1CLFFBQVcsRUFBRSxTQUFpQjtRQUNsRSxNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDO2FBQ3hCLElBQUksQ0FBQyxDQUFDLENBQUM7YUFDUCxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBaUIsQ0FBQztRQUN0QyxPQUFPLElBQUksaUJBQWlCLENBQUksUUFBUSxFQUFFLFNBQVMsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBRUQsTUFBTSxDQUFDLGVBQWUsQ0FBbUIsU0FBaUIsRUFBRSxXQUE2QjtRQUN2RixPQUFPLElBQUksaUJBQWlCLENBQzFCLFdBQVcsQ0FBQyxNQUFXLEVBQ3ZCLFNBQVMsRUFDVCxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBaUIsQ0FDdkQsQ0FBQztJQUNKLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsTUFBTSxDQUFDLFVBQVUsQ0FBbUIsTUFBNkI7UUFDL0QsTUFBTSxNQUFNLEdBQUcsWUFBWSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM3QyxNQUFNLFNBQVMsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ25ELE1BQU0sV0FBVyxHQUFHLE1BQU0sQ0FBQyxlQUFlLEVBQXNCLENBQUM7UUFDakUsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLFNBQVMsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILE1BQU0sQ0FBQyxZQUFZLENBQW1CLElBQU87UUFDM0MsT0FBTztZQUNMLFVBQVUsRUFBRSxDQUFDLE1BQTZCLEVBQUUsRUFBRTtnQkFDNUMsTUFBTSxNQUFNLEdBQUcsWUFBWSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDN0MsTUFBTSxTQUFTLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDbkQsTUFBTSxXQUFXLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7Z0JBQy9DLE9BQU8sSUFBSSxpQkFBaUIsQ0FBQyxJQUFJLEVBQUUsU0FBUyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1lBQzdELENBQUM7U0FDRixDQUFDO0lBQ0osQ0FBQztDQU1GIn0=